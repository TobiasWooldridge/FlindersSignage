<html ng-app="signage">
<head>
    <title>Flinders Signage</title>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular-sanitize.js"></script>


    <link href="css/styles.css" rel="stylesheet"/>
</head>
<body ng-controller="SlidesController">

<div class="slides">
    <div ng-controller="NewsController" class="slide {{news_slide_styles}}">
        <div ng-repeat="article in [news.latestArticle]" ng-include="'views/news-article.html'"></div>
    </div>

    <div ng-controller="TimetableController" class="slide {{timetable_slide_styles}}">
        <div ng-include="'views/building.html'"></div>
    </div>

    <div class="slide {{weather_slide_styles}}">
        <img src="http://placekitten.com/600/900" />
    </div>
</div>

<header id="flinders-sticky">
    <div>
        <img alt="Flinders" class="logo" src="images/flinders-logo.png" width="99" height="150" />
        <h1>{{ building.name }} <small>{{building.code }}</small> <small>(Week 7)</small></h1>
    </div>
</header>

<script>
    function bootstrapAngular() {
        var config = {
            api_path : "http://flinders-signage.herokuapp.com/api/v1/",
            slide_time : 10000
        };

        var signage = angular.module('signage', ['ngSanitize']);

        signage.factory('buildingFactory', function ($http) {
            return {
                getBuildingAsync: function (building_code, callback) {
                    $http.get(config.api_path + 'buildings/' + building_code + '.json').success(callback);
                }
            };
        });

        signage.factory('roomsFactory', function ($http) {
            return {
                getRoomsAsync: function (building_code, callback) {
                    $http.get(config.api_path + 'buildings/' + building_code + '/rooms.json').success(callback);
                }
            };
        });

        signage.factory('newsFactory', function ($http) {
            return {
                getNewsAsync: function (callback) {
                    $http.get(config.api_path + 'news.json').success(callback);
                }
            };
        });

        signage.controller('SlidesController', function ($scope, $timeout, buildingFactory) {
            var poll = function() {
                buildingFactory.getBuildingAsync('IST', function (building) {
                    $scope.building = building;
                });

                $timeout(poll, 60000);
            };


            $scope.news_slide_style = "";
            $scope.timetable_slide_style = "";

            var slide_ids = [ "news", "timetable", "weather" ];
            var current_slide = 0;

            var transition = function() {
                var previous_slide = current_slide;
                current_slide = (current_slide + 1) % slide_ids.length;

                var i;
                for (i = 0; i < slide_ids.length; i++) {
                    var styles = "";
                    styles += (i == previous_slide ? ' outgoing' : '');
                    styles += (i == current_slide ? ' active' : ' inactive');

                    $scope[slide_ids[i] + "_slide_styles"] = styles;
                }

                $timeout(transition, config.slide_time);
            };

            poll();
            transition();
        });

        signage.controller('NewsController', function ($scope, newsFactory) {
            newsFactory.getNewsAsync(function (data) {
                $scope.news = {
                    posts: data,
                    latestArticle: data[0]
                };
            });
        });

        signage.controller('TimetableController', function ($scope, roomsFactory, $timeout) {
            var poll = function() {
                roomsFactory.getRoomsAsync("IST", function (rooms) {
                    $scope.booked_rooms = [];
                    $scope.empty_rooms = [];

                    angular.forEach(rooms, function(room) {
                        if (room.is_empty) {
                            $scope.empty_rooms.push(room);
                        }
                        else {
                            $scope.booked_rooms.push(room);
                        }
                    });

                });

                $timeout(poll, 60000);
            };

            poll();
        });
    }

    bootstrapAngular();
</script>
</body>
</html>
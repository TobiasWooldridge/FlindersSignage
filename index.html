<html ng-app="signage">
<head>
    <title>Flinders Signage</title>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular-sanitize.js"></script>
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet"/>
    <link href="bootstrap/css/bootstrap-theme.css" rel="stylesheet"/>


    <link href="styles.css" rel="stylesheet"/>
</head>
<body>

<div ng-controller="SlidesController" class="slides">
    <div ng-controller="NewsController" class="slide {{news_slide_style}}">
        <div ng-repeat="article in [news.latestArticle]" ng-include="'views/news-article.html'"></div>
    </div>

    <div ng-controller="TimetableController" class="slide {{timetable_slide_style}}">
        <div ng-include="'views/building.html'"></div>
    </div>
</div>

<script>
    function bootstrapAngular() {
        var config = {
            api_path : "http://flinders-signage.herokuapp.com/api/v1/",
            slide_time : 5000
        };



        var signage = angular.module('signage', ['ngSanitize']);

        signage.factory('buildingFactory', function ($http) {
            return {
                getBuildingsAsync: function (building_code, room_code, callback) {
                    $http.get(config.api_path + 'buildings.json').success(callback);
                },
                getBuildingAsync: function (building_code, callback) {
                    $http.get(config.api_path + 'buildings/' + building_code + '.json').success(callback);
                }
            };
        });

        signage.factory('newsFactory', function ($http) {
            return {
                getNewsAsync: function (callback) {
                    $http.get(config.api_path + 'news.json').success(callback);
                }
            };
        });

        signage.controller('SlidesController', function ($scope, $timeout) {
            $scope.news_slide_style = "";
            $scope.timetable_slide_style = "";

            var slide_styles = ["news_slide_style", "timetable_slide_style"];
            var current_slide = 0;

            var transition = function() {
                current_slide = (current_slide + 1) % slide_styles.length;

                var i;
                for (i = 0; i < slide_styles.length; i++) {
                    $scope[slide_styles[i]] = (i == current_slide ? 'active' : 'inactive');
                }

                $timeout(transition, config.slide_time);
            };

            transition();
        });

        signage.controller('NewsController', function ($scope, newsFactory) {
            newsFactory.getNewsAsync(function (data, status, headers, config) {
                $scope.news = {
                    posts: data,
                    latestArticle: data[0]
                };
            });
        });

        signage.controller('TimetableController', function ($scope, buildingFactory, $timeout) {
            var poll = function() {
                buildingFactory.getBuildingAsync('IST', function (building, status, headers, config) {
                    $scope.building = building;
                });

                $timeout(poll, 1000);
            };

            poll();
        });
    }

    bootstrapAngular();
</script>
</body>
</html>